generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Roles {
  ADMIN
  VENDOR
  USER
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum VendorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum AddressType {
  HOME
  WORK
  OTHER
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  RAZORPAY
  PAYPAL
  PAYTM
  OTHER
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  UPI
  WALLET
  NET_BANKING
  COD
  OTHER
}



//Country of Origin is set to India by default

// Category model specifically designed for clothing/apparel hierarchy
model Category {
  id            String     @id @default(uuid())
  name          String     
  description   String?    @db.Text
  slug          String     @unique
  image         String?
  level        Int        @default(0) // 0 for root categories, 1 for subcategories,  last 2 .
  is_featured   Boolean    @default(false)
  active        Boolean    @default(true)
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt

  // Parent-Child relationship
  parent_id     String?                                     
  parent        Category?   @relation("CategoryHierarchy", fields: [parent_id], references: [id], onDelete: SetNull)
  children      Category[]  @relation("CategoryHierarchy")   

  // Products
  products      Product[]
  
  // Attributes associated with this category
  attributes    CategoryAttribute[]
}

// Junction model for Category-Attribute many-to-many relationship
model CategoryAttribute {
  category_id   String
  attribute_id  String
  required      Boolean  @default(false)  // Add this field for validation purposes

  category      Category  @relation(fields: [category_id], references: [id], onDelete: Cascade)
  attribute     Attribute @relation(fields: [attribute_id], references: [id], onDelete: Cascade)

  @@id([category_id, attribute_id])
}

// Attribute model for flexible product attributes
model Attribute {
  id           String         @id @default(uuid())
  name         String         @unique
  description  String?        @db.Text
  type         String         @default("string") // string, number, boolean, date
  values       AttributeValue[]
  
  // Categories that use this attribute
  categories   CategoryAttribute[]

  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt
}

model AttributeValue {
  id            String     @id @default(uuid())
  attribute_id  String
  value         String
  display_value String?
  
  attribute     Attribute  @relation(fields: [attribute_id], references: [id], onDelete: Cascade)
  
  products      ProductAttributeValue[]

  @@unique([attribute_id, value])
}

model ProductAttributeValue {
  product_id         String
  attribute_value_id String
  
  product        Product        @relation(fields: [product_id], references: [id], onDelete: Cascade)
  attributeValue AttributeValue @relation(fields: [attribute_value_id], references: [id], onDelete: Cascade)
  
  @@id([product_id, attribute_value_id])
}

model Users {
  id                          String          @id @default(uuid())
  name                        String
  email                       String          @unique
  username                    String?         @unique
  profile_picture             String?
  roles                       Roles[]
  password                    String
  account_status              AccountStatus   @default(ACTIVE)
  verification_code           String?
  incorect_attempt            Int?
  retry_timestamp             DateTime?
  vefification_hash           String?         @unique
  verification_code_expire_at DateTime?
  is_verified                 Boolean
  // Relationships
  Sessions                    Sessions[]
  Addresses                   Address[]
  Orders                      Order[]
  CartItems                   CartItem[]
  Wishlists                   Wishlist[]
  Products                    Product[]       @relation("VendorProducts")
  Reviews                     ProductReview[]
  Vendor                      Vendor?
  Payment                     Payment[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model Sessions {
  id            String    @id @default(uuid())
  user_id       String
  token         String    @unique @db.Text
  ip_address    String?
  user_agent    String?   @db.Text
  last_activity DateTime?
  expires_at    DateTime
  created_at    DateTime  @default(now())
  
  Users         Users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model Vendor {
  id              String       @id @default(uuid())
  user_id         String       @unique
  gst_number      String       @unique
  pan_number      String       @unique
  shop_name       String
  shop_address    String
  phone_number    String
  status          VendorStatus @default(PENDING)
  
  User            Users        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  Products        Product[]

  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
}

model Address {
  id           String      @id @default(uuid())
  user_id      String
  full_name    String
  phone        String
  pincode      String
  house_no     String
  area         String
  landmark     String?
  city         String
  state        String
  address_type AddressType @default(HOME)

  Users        Users       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  Orders       Order[]
}

model Product {
  id              String      @id @default(uuid())
  title           String
  description     String
  sku             String?     // Stock Keeping Unit
  price           Float
  vendor_id       String
  images          String[]    // Array of image URLs
  
  // Apparel specific fields
  brand           String?
  gender          String?     // Men's, Women's, Unisex, Kids
  season          String?     // Summer, Winter, Monsoon, All Season
  weight          Float?      // in grams
  color_name      String?     // Primary color name (e.g., "Navy Blue")
  color_family    String?     // Color family for filtering (e.g., "Blue")
  
  // Archiving and soft deletion
  is_active       Boolean     @default(true)
  archived        Boolean     @default(false)
  archived_at     DateTime?
  
  // Category relation replacing enum
  category_id     String?
  category        Category?   @relation(fields: [category_id], references: [id])
    // Product attributes
  attributeValues ProductAttributeValue[]
  
  // Other relations
  Vendor          Vendor      @relation(fields: [vendor_id], references: [id], onDelete: Cascade)
  OrderItems      OrderItem[]
  CartItems       CartItem[]
  Wishlists       Wishlist[]
  Inventory       Inventory?  // A product has only base inventory now
  VariationInventory VariationInventory[] // New relation for variation-specific inventory
  Variations      ProductVariation[]
  Reviews         ProductReview[]
  Users           Users[]     @relation("VendorProducts")
}

model ProductVariation {
  id          String    @id @default(uuid())
  product_id  String
  size        String    
  color       String
  sku         String?   
  price_mod   Float?    
  images      String[]  
  Product     Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)
  Inventory   VariationInventory? // Each variation has its own inventory
  
  @@unique([product_id, size, color])
}


// Base inventory for product (main stock)
model Inventory {
  id           String    @id @default(uuid())
  product_id   String    @unique // One inventory per product
  quantity     Int
  low_stock_threshold Int @default(10)
  last_updated DateTime  @default(now())

  Product      Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)
}

// Granular inventory tracking per variation
model VariationInventory {
  id                String    @id @default(uuid())
  variation_id      String    @unique // One inventory per variation
  quantity          Int
  low_stock_threshold Int     @default(5)
  reserved_quantity Int       @default(0) // For items in checkout process
  last_updated      DateTime  @default(now())
  
  Variation         ProductVariation @relation(fields: [variation_id], references: [id], onDelete: Cascade)

  Product Product[]
}

model Order {
  id            String      @id @default(uuid())
  user_id       String
  address_id    String
  total_amount  Float
  status        OrderStatus @default(PENDING)
  created_at    DateTime    @default(now())
  
  // Archiving fields
  archived      Boolean     @default(false)
  archived_at   DateTime?

  Users         Users       @relation(fields: [user_id], references: [id])
  Address       Address     @relation(fields: [address_id], references: [id])
  OrderItems    OrderItem[]
  Payment       Payment?
}

model OrderItem {
  id                 String   @id @default(uuid())
  order_id           String
  product_id         String
  quantity           Int
  price              Float    
  
  variation_id       String?
  size               String?
  color              String?
  
  Order              Order    @relation(fields: [order_id], references: [id])
  Product            Product  @relation(fields: [product_id], references: [id])
}

// New archive tables for long-term storage

model ArchivedProduct {
  id              String    @id @default(uuid())
  original_id     String    @unique // The ID from the original Product table
  data            Json      // All product data stored as JSON
  archived_at     DateTime  @default(now())
}

model ArchivedOrder {
  id              String    @id @default(uuid())
  original_id     String    @unique // The ID from the original Order table
  user_id         String    // Keeping direct reference to user
  data            Json      // All order data including items as JSON
  archived_at     DateTime  @default(now())
}

model CartItem {
  id         String   @id @default(uuid())
  user_id    String
  product_id String
  quantity   Int
  Users      Users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  Product    Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
}

model Wishlist {
  id         String   @id @default(uuid())
  user_id    String
  product_id String

  Users      Users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  Product    Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
}

model ProductReview {
  id         String   @id @default(uuid())
  product_id String
  user_id    String
  rating     Int      @default(5) // 1 to 5
  review     String?  @db.Text
  images     String[] // User uploaded images with review
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  
  Product    Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  Users      Users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@unique([product_id, user_id]) // One review per user per product
}

model Payment {
  id             String          @id @default(uuid())
  order_id       String          @unique
  user_id        String
  provider       PaymentProvider
  payment_id     String          @unique 
  amount         Float
  currency       String          @default("INR")
  status         PaymentStatus   @default(PENDING) 
  method         PaymentMethod?
  created_at     DateTime        @default(now())
  paid_at        DateTime?
  
  Order          Order           @relation(fields: [order_id], references: [id])
  Users          Users           @relation(fields: [user_id], references: [id])
}
